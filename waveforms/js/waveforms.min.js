/* WaveForms by Photon Storm Ltd. */
var WaveForms=function(){this.bmd=null,this.icons=null,this.handles=null,this.overHandle=null,this.draggedHandle=null,this.interpolation=Phaser.Math.linearInterpolation,this.offset=new Phaser.Point(80,32),this.points=[null,{type:WaveForms.LINEAR,closed:!1,x:[0,128,256,384,512,640],y:[240,240,240,240,240,240]},{type:WaveForms.LINEAR,closed:!1,x:[0,128,256,384,512,640],y:[240,240,240,240,240,240]},{type:WaveForms.LINEAR,closed:!1,x:[0,128,256,384,512,640],y:[240,240,240,240,240,240]},{type:WaveForms.LINEAR,closed:!1,x:[0,128,256,384,512,640],y:[240,240,240,240,240,240]},{type:WaveForms.LINEAR,closed:!1,x:[0,128,256,384,512,640],y:[240,240,240,240,240,240]},{type:WaveForms.LINEAR,closed:!1,x:[0,128,256,384,512,640],y:[240,240,240,240,240,240]},{type:WaveForms.LINEAR,closed:!1,x:[0,128,256,384,512,640],y:[240,240,240,240,240,240]},{type:WaveForms.LINEAR,closed:!1,x:[0,128,256,384,512,640],y:[240,240,240,240,240,240]}],this.path=[],this.currentPath=null,this.enableSnap=!1,this.editMode=!1,this.closePath=!1,this.linearTool=null,this.bezierTool=null,this.catmullTool=null,this.closeTool=null,this.editTool=null,this.snapTool=null,this.currentMode=null,this.coords=null,this.hint=null,this.sprite,this.bi=0};WaveForms.LINEAR=0,WaveForms.BEZIER=1,WaveForms.CATMULL=2,WaveForms.CLOSEPATH=3,WaveForms.EDIT=4,WaveForms.SNAP=5,WaveForms.PATH=6,WaveForms.SPRITE=7,WaveForms.SAVE=8,WaveForms.prototype={init:function(){console.log("game",this.game),this.game.renderer.renderSession.roundPixels=!0,this.stage.backgroundColor="#204090"},preload:function(){this.load.atlas("icons","assets/waveforms.png","assets/waveforms.json"),this.load.bitmapFont("font","assets/font.png","assets/font.xml"),this.load.image("ship","assets/ship.png")},create:function(){this.add.sprite(0,0,"icons","grid"),this.bmd=this.add.bitmapData(this.game.width,this.game.height),this.bmd.addToWorld(),this.random(1),this.random(2),this.random(3),this.random(4),this.random(5),this.random(6),this.random(7),this.random(8),this.icons=this.add.group(),this.linearTool=this.icons.add(new Icon(this,WaveForms.LINEAR,0,"linear",Phaser.Keyboard.L,!1)),this.bezierTool=this.icons.add(new Icon(this,WaveForms.BEZIER,64,"bezier",Phaser.Keyboard.B,!1)),this.catmullTool=this.icons.add(new Icon(this,WaveForms.CATMULL,128,"catmull",Phaser.Keyboard.M,!1)),this.closeTool=this.icons.add(new Icon(this,WaveForms.CLOSEPATH,192,"close",Phaser.Keyboard.C,!0)),this.editTool=this.icons.add(new Icon(this,WaveForms.EDIT,256,"edit",Phaser.Keyboard.E,!0)),this.snapTool=this.icons.add(new Icon(this,WaveForms.SNAP,320,"snap",Phaser.Keyboard.S,!0)),this.currentPath=this.icons.add(new Icon(this,WaveForms.PATH,384,"path1",Phaser.Keyboard.ONE,!1)),this.icons.add(new Icon(this,WaveForms.PATH,416,"path2",Phaser.Keyboard.TWO,!1)),this.icons.add(new Icon(this,WaveForms.PATH,448,"path3",Phaser.Keyboard.THREE,!1)),this.icons.add(new Icon(this,WaveForms.PATH,480,"path4",Phaser.Keyboard.FOUR,!1)),this.icons.add(new Icon(this,WaveForms.PATH,512,"path5",Phaser.Keyboard.FIVE,!1)),this.icons.add(new Icon(this,WaveForms.PATH,544,"path6",Phaser.Keyboard.SIX,!1)),this.icons.add(new Icon(this,WaveForms.PATH,576,"path7",Phaser.Keyboard.SEVEN,!1)),this.icons.add(new Icon(this,WaveForms.PATH,608,"path8",Phaser.Keyboard.EIGHT,!1)),this.icons.add(new Icon(this,WaveForms.SPRITE,640,"sprite",Phaser.Keyboard.SPACEBAR,!0)),this.icons.add(new Icon(this,WaveForms.SAVE,704,"save",Phaser.Keyboard.V,!1)),this.icons.y=600,this.phaserIcon=this.add.sprite(768,536,"icons","phaser"),this.phaserIcon.inputEnabled=!0,this.phaserIcon.events.onInputOver.add(function(a){a.tint=16776960}),this.phaserIcon.events.onInputOut.add(function(a){a.tint=16777215}),this.phaserIcon.events.onInputDown.add(function(){window.location.href="http://phaser.io/waveforms"}),this.handles=this.add.group();for(var a=0;64>a;a++)this.handles.add(new Handle(this));this.sprite=this.add.sprite(0,0,"ship"),this.sprite.anchor.set(.5),this.sprite.visible=!1,this.currentMode=this.linearTool,this.currentMode.select(),this.currentPath.select(),this.coords=this.add.bitmapText(744,6,"font","X: 0\nY: 0",16),this.hint=this.add.bitmapText(4,6,"font"," ",16);var b=this.input.keyboard.addKey(Phaser.Keyboard.R);b.onDown.add(this.random,this),this.createSplash()},createSplash:function(){this.intro=this.add.group();var a=this.add.bitmapData(800,600);a.rect(0,0,800,600,"rgba(0,0,0,0.4)");var b=(this.intro.create(0,0,a),this.intro.create(100,200,"icons","logo"),"- Phaser WaveForms -\n\nBy Richard Davey, Photon Storm 2015\n\nhttp://phaser.io/waveforms/"),c=this.add.bitmapText(0,280,"font",b,16);c.align="center",c.x=400-c.width/2,this.intro.add(c),this.input.onDown.addOnce(this.closeSplash,this)},closeSplash:function(){this.add.tween(this.intro).to({alpha:0},500,"Linear",!0),this.add.tween(this.icons).to({y:536},500,"Linear",!0,250),this.changePath(this.currentPath),this.input.addMoveCallback(this.plot,this),this.input.onDown.add(this.addPoint,this)},random:function(a){for(var b=this.points[a].y,c=0;c<b.length;c++)b[c]=this.rnd.between(32,432)},setHint:function(a){if("string"==typeof a)this.hint.text=""===a?this.editMode?"Click to add a node\nSelect existing node to delete it":"Drag a node":a;else switch(a){case WaveForms.LINEAR:this.hint.text="Set path type to Linear";break;case WaveForms.BEZIER:this.hint.text="Set path type to Bezier";break;case WaveForms.CATMULL:this.hint.text="Set path type to Catmull Rom";break;case WaveForms.CLOSEPATH:this.hint.text="Toggle path closed or open ended";break;case WaveForms.EDIT:this.editMode||(this.hint.text="Toggle Edit Mode");break;case WaveForms.SNAP:this.hint.text="Toggle Snap to Grid";break;case WaveForms.PATH:this.hint.text="Change Path";break;case WaveForms.SPRITE:this.hint.text="Toggle Sprite on Path";break;case WaveForms.SAVE:this.hint.text="Save Path data to console.log"}},selected:function(a){switch(a.type){case WaveForms.LINEAR:this.setLinear(a);break;case WaveForms.BEZIER:this.setBezier(a);break;case WaveForms.CATMULL:this.setCatmull(a);break;case WaveForms.CLOSEPATH:this.toggleClose(a);break;case WaveForms.EDIT:this.toggleEdit(a);break;case WaveForms.SNAP:this.toggleSnap(a);break;case WaveForms.PATH:this.changePath(a);break;case WaveForms.SPRITE:this.toggleSprite(a);break;case WaveForms.SAVE:this.save(a),a.deselect()}},setLinear:function(a){this.currentMode.deselect(),this.currentMode=a,this.currentMode.select(),this.points[this.currentPath.pathIndex].type=WaveForms.LINEAR,this.interpolation=Phaser.Math.linearInterpolation,this.plot(!0)},setBezier:function(a){this.currentMode.deselect(),this.currentMode=a,this.currentMode.select(),this.points[this.currentPath.pathIndex].type=WaveForms.BEZIER,this.interpolation=Phaser.Math.bezierInterpolation,this.plot(!0)},setCatmull:function(a){this.currentMode.deselect(),this.currentMode=a,this.currentMode.select(),this.points[this.currentPath.pathIndex].type=WaveForms.CATMULL,this.interpolation=Phaser.Math.catmullRomInterpolation,this.plot(!0)},toggleClose:function(a){var b=this.points[this.currentPath.pathIndex].x,c=this.points[this.currentPath.pathIndex].y;this.closePath?(b.pop(),c.pop()):(b.push(b[0]),c.push(c[0])),this.closePath=this.closePath?!1:!0,this.points[this.currentPath.pathIndex].closed=this.closePath,this.closePath?a.select():a.deselect(),this.plot(!0)},toggleEdit:function(){this.editMode=this.editMode?!1:!0,this.hint.text=this.editMode?"Click to add a node\nSelect existing node to delete it":"Drag a node"},addPoint:function(a){if(this.editMode&&!(a.y>=536)){var b=this.points[this.currentPath.pathIndex].x,c=this.points[this.currentPath.pathIndex].y;if(console.log("addPoint",this.overHandle),null!==this.overHandle){this.overHandle.hide(),b=[],c=[];for(var d=0,e=0;e<this.handles.children.length;e++){var f=this.handles.children[e];f.exists&&(f.index=d,b[d]=f.x-this.offset.x,c[d]=f.y-this.offset.y,d++)}this.points[this.currentPath.pathIndex].closed&&(b.push(b[0]),c.push(c[0])),this.points[this.currentPath.pathIndex].x=b,this.points[this.currentPath.pathIndex].y=c,this.hint.text="Node deleted\nClick to add a new node\nSelect existing node to delete it"}else{this.points[this.currentPath.pathIndex].closed&&(b.pop(),c.pop()),b.push(a.x-this.offset.x),c.push(a.y-this.offset.y);var d=b.length-1,f=this.handles.getFirstExists(!1);f.show(d,b[d],c[d]),this.points[this.currentPath.pathIndex].closed&&(b.push(b[0]),c.push(c[0])),this.hint.text="Node created\nClick to add another node\nSelect existing node to delete it"}this.plot(!0)}},toggleSnap:function(){this.enableSnap=this.enableSnap?!1:!0,this.handles.callAll("updateSnap")},changePath:function(a){this.handles.callAll("hide"),this.draggedHandle=null,this.currentMode.deselect(),this.currentPath.deselect(),this.currentPath=a,this.currentPath.select();for(var b=this.currentPath.pathIndex,c=0;c<this.points[b].x.length;c++){var d=this.handles.getFirstExists(!1);d.show(c,this.points[b].x[c],this.points[b].y[c])}switch(this.points[b].closed?(this.closePath=!0,this.closeTool.select()):(this.closePath=!1,this.closeTool.deselect()),this.points[b].type){case WaveForms.LINEAR:this.setLinear(this.linearTool);break;case WaveForms.BEZIER:this.setBezier(this.bezierTool);break;case WaveForms.CATMULL:this.setCatmull(this.catmullTool)}},toggleSprite:function(){this.sprite.visible?this.sprite.visible=!1:(this.bi=0,this.sprite.visible=!0)},save:function(){this.setHint("Check the console"),console.log(JSON.stringify(this.points))},plot:function(a){if(("undefined"==typeof a||a instanceof Phaser.Pointer)&&(a=!1),null!==this.draggedHandle||a){var b=this.points[this.currentPath.pathIndex].x,c=this.points[this.currentPath.pathIndex].y,d=this.draggedHandle;if(null!==d){b[d.index]=d.x-this.offset.x,c[d.index]=d.y-this.offset.y,this.closePath&&(b[b.length-1]=b[0],c[c.length-1]=c[0]);var e=Math.floor(d.x-this.offset.x),f=Math.floor(d.y-this.offset.y);this.coords.text="X: "+e+"\nY: "+f}this.bmd.clear();var g=0,h=1/(100*b.length);this.path=[];for(var i=0;1>=i;i+=h){var j=this.interpolation.call(Phaser.Math,b,i),k=this.interpolation.call(Phaser.Math,c,i),l={x:j,y:k,angle:0};g>0&&(l.angle=this.math.angleBetweenPoints(this.path[g-1],l)),this.path.push(l),g++,this.bmd.rect(this.offset.x+j,this.offset.y+k,1,1,"rgba(255, 255, 255, 1)")}}},update:function(){this.sprite.visible&&(this.bi+=2,this.bi>=this.path.length&&(this.bi=0),this.sprite.x=this.offset.x+this.path[this.bi].x,this.sprite.y=this.offset.y+this.path[this.bi].y,this.sprite.rotation=this.path[this.bi].angle)}};var Handle=function(a){this.editor=a,Phaser.Sprite.call(this,a.game,0,0,"icons","marker-r"),this.exists=!1,this.visible=!1,this.anchor.set(.5),this.inputEnabled=!0,this.input.enableDrag(),this.events.onInputOver.add(this.onOver,this),this.events.onInputOut.add(this.onOut,this),this.events.onDragStart.add(this.dragStart,this),this.events.onDragStop.add(this.dragStop,this)};Handle.prototype=Object.create(Phaser.Sprite.prototype),Handle.prototype.constructor=Handle,Handle.prototype.show=function(a,b,c){this.index=a,this.x=this.editor.offset.x+b,this.y=this.editor.offset.y+c,this.exists=!0,this.visible=!0,this.updateSnap()},Handle.prototype.hide=function(){this.exists=!1,this.visible=!1,this.editor.draggedHandle=null,this.editor.overHandle=null},Handle.prototype.updateSnap=function(){this.editor.enableSnap?this.input.enableSnap(20,20,!0,!0):this.input.disableSnap()},Handle.prototype.onOver=function(){if(this.exists){this.frameName="marker-g";var a=Math.floor(this.x-this.editor.offset.x),b=Math.floor(this.y-this.editor.offset.y);this.editor.coords.text="X: "+a+"\nY: "+b,this.editor.overHandle=this}},Handle.prototype.onOut=function(){this.exists&&(this.frameName="marker-r",this.editor.overHandle=null)},Handle.prototype.dragStart=function(){this.exists&&(this.frameName="marker-g",this.editor.draggedHandle=this,this.editor.setHint("Dragging node "+this.index))},Handle.prototype.dragStop=function(){this.exists&&(this.frameName="marker-r",this.editor.draggedHandle=null,this.editor.setHint(""))};var Icon=function(a,b,c,d,e,f){this.editor=a,Phaser.Sprite.call(this,a.game,c,0,"icons",d),this.type=b,this.enabled=!1,this.pathScreen=!1,this.isToggle=f,"path"===d.substr(0,4)&&(this.pathScreen=!0,this.pathIndex=parseInt(d.substr(4,1),10)),this.pathScreen?(this.outline=this.addChild(new Phaser.Sprite(this.game,0,0,"icons","over-path")),this.active=this.addChild(new Phaser.Sprite(this.game,0,0,"icons","active-path")),this.active.visible=!1):this.outline=this.addChild(new Phaser.Sprite(this.game,0,0,"icons","over")),this.outline.visible=!1,this.inputEnabled=!0,this.events.onInputOver.add(this.onOver,this),this.events.onInputOut.add(this.onOut,this),this.events.onInputDown.add(this.onDown,this),this.shortcut=a.input.keyboard.addKey(e),this.shortcut.onDown.add(this.onDown,this)};Icon.prototype=Object.create(Phaser.Sprite.prototype),Icon.prototype.constructor=Icon,Icon.prototype.select=function(){this.enabled=!0,this.pathScreen?this.active.visible=!0:(this.outline.frameName="selected",this.outline.visible=!0)},Icon.prototype.deselect=function(){this.enabled=!1,this.pathScreen?this.active.visible=!1:this.outline.visible=!1},Icon.prototype.onOver=function(){this.outline.frameName=this.pathScreen?"over-path":"over",this.outline.visible=!0,this.editor.setHint(this.type)},Icon.prototype.onOut=function(){this.pathScreen?this.outline.visible=!1:this.enabled?this.outline.frameName="selected":this.outline.visible=!1,this.editor.setHint("")},Icon.prototype.onDown=function(){if(this.isToggle)this.enabled?this.deselect():this.select(),this.editor.selected(this);else{if(this.enabled)return;this.pathScreen?this.active.visible=!0:(this.outline.frameName="selected",this.outline.visible=!0),this.enabled=!0,this.editor.selected(this)}};